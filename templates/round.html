{% extends "base.html" %}
{% block content %}
<h2>Runde {{ round_number }} von {{ session['rounds'] }}</h2>

<div class="card" style="margin-bottom:12px">
  <strong>Ihre Aufgabe:</strong> Wählen Sie eine Option.
  <span class="badge">A</span>
  <span class="badge">B</span>
</div>

<div class="grid grid-2">
  <div class="card">
    <h3>Option A</h3>
    <p class="small">fester Betrag, unabhängig von den Entscheidungen anderer</p>
    <p>
      <strong>Ihre Kosten (A):</strong>
      <span class="mono">{{ a_cost_display }}</span> ECU
    </p>
    <div class="notice small">
      Auszahlung dieser Runde = <span class="mono">M − Kosten</span>.
      Basisbetrag M = <span class="mono">{{ base_payout }}</span> ECU.
    </div>
  </div>

  <div class="card">
    <h3>Option B</h3>
    <p class="small" style="opacity:.9">
      Ihre Kosten hängen davon ab, wie viele der <strong>anderen</strong> in Ihrer Gruppe <strong>A</strong> wählen.
    </p>
    <table class="table small">
      <thead>
        <tr>
          <th>Andere A</th>
          <th>1×A</th>
          <th>2×A</th>
          <th>3×A</th>
          <th>4×A</th>
          <th>5×A</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Ihre Kosten (B)</td>
          {% for c in b_row_costs %}
            <td class="mono">{{ c }} ECU</td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </div>
</div>

<form onsubmit="return sendChoice(event)" style="margin-top:10px">
  <div class="grid grid-2">
    <button type="submit" name="choice" value="A">Option A wählen</button>
    <button type="submit" name="choice" value="B" class="secondary">Option B wählen</button>
  </div>
</form>

<h3 style="margin-top:18px">Status</h3>
<div class="notice" id="ing">Eingänge: 0/{{ N }}</div>
<div class="notice" id="decided">Entschieden: –</div>
{% endblock %}

{% block scripts %}
<script>
const sid = "{{ session['id'] }}";
const r   = {{ round_number }};
const total = {{ N }};

async function sendChoice(e){
  e.preventDefault();
  const choice = e.submitter?.value;
  try{
    const res = await fetch('/choose', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({choice})
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    window.location.href = "/wait";
  }catch(err){
    alert("Fehler beim Senden.");
  }
  return false;
}

async function poll(){
  try{
    const res = await fetch(`/round_status?session_id=${sid}&round=${r}`);
    if(!res.ok) return;
    const d = await res.json();
    document.getElementById('ing').textContent = `Eingänge: ${d.decided}/${total}`;
    const names = (d.decided_players||[]).map(n => `<span class="kbd mono">Spieler ${n}</span>`).join(' ');
    document.getElementById('decided').innerHTML = `Entschieden: ${names || "–"}`;
    if(d.ready) window.location.href = "/reveal";
  }catch(e){}
}
setInterval(poll, 1000); poll();
</script>
{% endblock %}
