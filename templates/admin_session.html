{% extends "base.html" %}
{% block title %}Vaccination Game – Session-Details{% endblock %}

{% block content %}
<div class="page">

  <header class="pagehead">
    <div class="actions">
      <a class="btn btn-secondary" href="{{ url_for('admin') }}">← Zurück</a>
      <a class="btn btn-primary" href="{{ url_for('admin_export_session_xlsx', session_id=session.id) }}">Export (.xlsx)</a>
    </div>
  </header>

  <section class="card">
    <h3>Session-Details</h3>

    <div class="meta">
      <div class="metabox">
        <div class="label">Name:</div>
        <div class="value">{{ session.name }}</div>
        <div class="sub">id={{ session.id }}</div>
      </div>

      <div class="chips">
        <span class="chip">N={{ session.group_size }}</span>
        <span class="chip">R={{ session.rounds }}</span>
        <span class="chip">M={{ session.starting_balance|int }}</span>
        <span class="chip">watch={{ session.watch_time|int }}s</span>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="listhead">
      <div>
        <strong>Live-Status</strong>
      </div>
      <div id="round_info">Runde: {{ round_number }} • Entschieden: <span id="decided_count">0</span>/<span id="need">{{ session.group_size }}</span></div>
    </div>

    <div class="tablewrap">
      <table class="tbl" id="ptable" aria-label="Teilnehmerstatus">
        <thead>
          <tr>
            <th>#</th>
            <th>Code</th>
            <th>Runde</th>
            <th>Entschieden</th>
            <th>Wahl</th>
            <th>Letzte Auszahlung (Runde)</th>
          </tr>
        </thead>
        <tbody>
          <!-- gefüllt per JS -->
        </tbody>
      </table>
    </div>
  </section>

</div>

<script>
const sid = "{{ session.id }}";
const needEl = document.getElementById("need");
const decidedCountEl = document.getElementById("decided_count");
const tbody = document.querySelector("#ptable tbody");
const roundInfo = document.getElementById("round_info");

async function poll() {
  try {
    const url = "{{ url_for('admin_session_status') }}" + "?session_id=" + encodeURIComponent(sid);
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) return;
    const data = await r.json();

    // Runde-Label
    if (data.session && data.session.current_round !== undefined) {
      roundInfo.textContent = "Runde: " + data.session.current_round + " • Entschieden: ";
      roundInfo.textContent += (data.decided_count ?? 0) + "/" + (needEl.textContent || "{{ session.group_size }}");
    }

    decidedCountEl.textContent = data.decided_count ?? 0;

    // Tabelle rendern
    const rows = (data.participants || []).map(p => {
      const decided = p.decided ? "✓" : "–";
      const choice = p.choice ? p.choice : "–";
      const payout = (p.balance !== null && p.balance !== undefined) ? p.balance : "–";
      return `<tr>
          <td>${p.player_no ?? ""}</td>
          <td>${p.code ?? ""}</td>
          <td>${p.round_display ?? ""}</td>
          <td>${decided}</td>
          <td>${choice}</td>
          <td>${payout}</td>
        </tr>`;
    }).join("");

    tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Keine Teilnehmer gefunden.</td></tr>`;
  } catch (e) {
    /* still */
  }
}

setInterval(poll, 1000);
poll();
</script>

<style>
.page { display:flex; flex-direction:column; gap:1rem; }
.pagehead { display:flex; align-items:center; justify-content:space-between; }
.actions { display:flex; gap:.5rem; }
.card { background:#0b1320; border:1px solid #1e2b43; border-radius:10px; padding:1rem; }

.meta { display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
.metabox .label { font-size:.9rem; color:#9fb0d1; }
.metabox .value { font-weight:600; }
.metabox .sub { font-size:.8rem; color:#7f90b1; margin-top:.15rem; }

.chips { display:flex; gap:.5rem; flex-wrap:wrap; }
.chip { background:#0f1a2a; border:1px solid #24324d; padding:.25rem .5rem; border-radius:999px; font-size:.85rem; }

.listhead { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }

.tablewrap { overflow:auto; }
.tbl { width:100%; border-collapse:collapse; }
.tbl th, .tbl td { padding:.6rem .5rem; border-bottom:1px dashed #24324d; text-align:left; }
.tbl thead th { color:#cfe1ff; font-weight:600; }
.muted { color:#9fb0d1; text-align:center; }

.btn { padding:.55rem .9rem; border:none; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; }
.btn-primary { background:#3a63ff; color:#fff; }
.btn-secondary { background:#24324d; color:#e8eefc; }
</style>
{% endblock %}
