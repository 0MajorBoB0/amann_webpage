<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title or 'Vaccination Game' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>{{ title or "Vaccination Game" }}</h1>
        {% block content %}{% endblock %}
      </div>
      <footer>Vaccination Game • SQLite gespeichert</footer>
    </div>

    {% if not admin_tab_guard %}
      <!-- Chat-UI (initial versteckt) -->
      <button id="chat-fab" style="display:none">Chat <span id="unread" class="unread" style="display:none">0</span></button>
      <div id="chat-panel" style="display:none">
        <div id="chat-head">
          <div id="chat-title">Chat</div>
          <button id="chat-close">▾</button>
        </div>
        <div id="chat-msgs"></div>
        <div id="chat-input">
          <input id="chat-text" type="text" placeholder="Nachricht…">
          <button id="chat-send">Senden</button>
        </div>
      </div>

      <script>
      (function loadSocketIoAndBoot(){
        function bootChat(){
          (async function(){
            const CHAT_OPEN = {{ (chat_open|default(false))|tojson }};

            // Nur anzeigen, wenn Spieler eingeloggt
            let me = null;
            try { const r = await fetch('/me'); if (r.ok) me = await r.json(); } catch(e){}
            const fab = document.getElementById('chat-fab');
            const panel = document.getElementById('chat-panel');
            if(!me){ fab.style.display='none'; panel.style.display='none'; return; }

            const closeBtn = document.getElementById('chat-close');
            const sendBtn  = document.getElementById('chat-send');
            const input    = document.getElementById('chat-text');
            const msgs     = document.getElementById('chat-msgs');
            const unread   = document.getElementById('unread');
            const title    = document.getElementById('chat-title');
            title.textContent = `Chat • ${me.alias || me.code}`;

            function addMsg(m){
              const el = document.createElement('div');
              el.className = 'msg';
              el.innerHTML = `<div class="meta"><span class="kbd mono">${m.alias}</span> • ${m.ts}</div><div class="text">${m.text}</div>`;
              msgs.appendChild(el); msgs.scrollTop = msgs.scrollHeight;
              if(panel.style.display==='none'){ unread.style.display='inline-block'; unread.textContent = String((+unread.textContent||0)+1); }
            }

            const socket = io({ transports:['websocket','polling'], withCredentials:true });
            socket.on('connect', ()=> socket.emit('join_room', {}) );
            socket.on('history', arr => { msgs.innerHTML=''; (arr||[]).forEach(addMsg); });
            socket.on('message', addMsg);

            function openPanel(){ panel.style.display='block'; fab.style.display='none'; unread.style.display='none'; unread.textContent='0'; }
            function closePanel(){ panel.style.display='none'; fab.style.display='inline-block'; }
            fab.addEventListener('click', openPanel);
            document.getElementById('chat-close').addEventListener('click', closePanel);
            sendBtn.addEventListener('click', ()=>{ const t = input.value.trim(); if(!t) return; socket.emit('send_message', {text:t}); input.value=''; });
            input.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

            fab.style.display='inline-block';
            if (CHAT_OPEN) openPanel(); else closePanel();
          })();
        }

        function loadLocal(){
          var s = document.createElement('script');
          s.src = '/socket.io/socket.io.js';
          s.onload = bootChat;
          s.onerror = loadCdn;
          document.head.appendChild(s);
        }
        function loadCdn(){
          var s = document.createElement('script');
          s.src = 'https://cdn.socket.io/4.7.5/socket.io.min.js';
          s.crossOrigin = 'anonymous';
          s.onload = bootChat;
          document.head.appendChild(s);
        }
        loadLocal();
      })();
      </script>
    {% else %}
      <script>
        (function(){
          const tabId = (Math.random().toString(36).slice(2) + Date.now().toString(36));
          fetch('/admin_tab_open',  {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tab_id: tabId})}).catch(()=>{});
          window.addEventListener('beforeunload', function(){
            navigator.sendBeacon('/admin_tab_close', JSON.stringify({tab_id: tabId}));
          });
        })();
      </script>
    {% endif %}

    {% block scripts %}{% endblock %}
  </body>
</html>
