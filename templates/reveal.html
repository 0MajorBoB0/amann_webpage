{% extends "base.html" %}
{% block content %}
<h2>Runde {{ round_number }} – Reveal</h2>
<div class="notice">Entscheidungen & Auszahlungen dieser Runde werden angezeigt …</div>

<div class="card">
  <div id="timer" class="mono">–</div>
  <table class="table" style="margin-top:8px">
    <thead>
      <tr>
        <th>Spieler</th>
        <th>Wahl</th>
        <th>Kosten</th>
        <th>Auszahlung (M − Kosten)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
const sid = "{{ session['id'] }}";
const r   = Number("{{ round_number }}");
const tEl = document.getElementById('timer');
const tbody = document.getElementById('tbody');

function fmt(x){ return Number(x||0).toFixed(0); }

async function load(){
  const res = await fetch(`/round_status?session_id=${sid}&round=${r}`);
  if(!res.ok) return;
  const d = await res.json();
  tbody.innerHTML = '';
  (d.players||[]).forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>Spieler ${p.player_no || "?"}</td>
      <td class="mono">${p.choice || "-"}</td>
      <td class="mono">${fmt(p.cost)}</td>
      <td class="mono">${fmt(p.payout)}</td>`;
    tbody.appendChild(tr);
  });
  tick(d.watch_ends_at);
}

function tick(endsAtIso){
  if(!endsAtIso){ tEl.textContent = "–"; return; }
  const end = new Date(endsAtIso).getTime();
  const id = setInterval(()=>{
    const s = Math.max(0, Math.floor((end - Date.now())/1000));
    tEl.textContent = s + " s";
    if(s<=0){ clearInterval(id); window.location.href = "/feedback"; }
  }, 2000);
}

load();
</script>
{% endblock %}
