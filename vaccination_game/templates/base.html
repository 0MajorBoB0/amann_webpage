
<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title or 'Vaccination Game' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>{{ title or "Vaccination Game" }}</h1>
        {% block content %}{% endblock %}
      </div>
      <footer>Vaccination Game • SQLite gespeichert</footer>
    </div>

    <!-- Floating Chat -->
    <button id="chat-fab">Chat <span id="unread" class="unread" style="display:none">0</span></button>
    <div id="chat-panel">
      <div id="chat-head">
        <div id="chat-title">Chat</div>
        <button id="chat-close">▾</button>
      </div>
      <div id="chat-msgs"></div>
      <div id="chat-input">
        <input id="chat-text" type="text" placeholder="Nachricht…">
        <button id="chat-send">Senden</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
    (async function(){
      let me = null;
      try { const r = await fetch('/me'); if(r.ok){ me = await r.json(); } } catch(e){}
      if(!me) return;

      const fab = document.getElementById('chat-fab');
      const panel = document.getElementById('chat-panel');
      const closeBtn = document.getElementById('chat-close');
      const sendBtn = document.getElementById('chat-send');
      const input = document.getElementById('chat-text');
      const msgs = document.getElementById('chat-msgs');
      const unread = document.getElementById('unread');
      const title = document.getElementById('chat-title');
      title.textContent = `Chat • ${me.alias || me.code}`;

      function addMsg(m){
        const el = document.createElement('div');
        el.className = 'msg';
        el.innerHTML = `<div class="meta"><span class="kbd mono">${m.alias}</span> • ${m.ts}</div><div class="text">${m.text}</div>`;
        msgs.appendChild(el);
        msgs.scrollTop = msgs.scrollHeight;
        if(panel.style.display==='none'){ unread.style.display='inline-block'; unread.textContent = String((+unread.textContent||0)+1); }
      }

      const socket = io({transports:['websocket','polling']});
      socket.on('connect', ()=> socket.emit('join_room', {session_id: me.session_id}) );
      socket.on('history', arr => { msgs.innerHTML=''; arr.forEach(addMsg); });
      socket.on('message', addMsg);

      function openPanel(){ panel.style.display='block'; fab.style.display='none'; unread.style.display='none'; unread.textContent='0'; }
      function closePanel(){ panel.style.display='none'; fab.style.display='inline-block'; }

      fab.addEventListener('click', openPanel);
      closeBtn.addEventListener('click', closePanel);
      sendBtn.addEventListener('click', ()=>{ const t = input.value.trim(); if(!t) return; socket.emit('send_message', {text: t}); input.value=''; });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendBtn.click(); }});

      fab.style.display='inline-block';
    })();
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
